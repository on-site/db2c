#!/usr/bin/env ruby

$LOAD_PATH.unshift 'lib'
require "db2c"

run = Db2c::Run.new *ARGV

exec "man #{run.gdir}/man/db2c.1" if run.help?

puts "wrapping #{$0} #{run.args}" if run.debug? && !run.nowrap?
exec "rlwrap -z pipeto -i -r -s 999999 -pBLUE -f #{run.autocomplete} -H ~/.db2c_history #{$0} --now #{run.args}" unless run.nowrap?

Db2c::Command.execute "use #{run.default_db}" if run.default_db

loop do
  print Db2c::Command.prompt
  begin
    command = Db2c::Command.new $stdin.gets
  rescue Interrupt
    exit
  end
  exit if command.quit?
  system 'less ~/.db2c_history' if command.history?
  system "man #{run.gdir}/man/db2c.1" if command.help?
  command.execute
end
